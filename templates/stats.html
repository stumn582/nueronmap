{% extends "base.html" %}

{% block content %}

<div class="stats-container">

    <!-- ê°ì • ë¶„ì„ ë¹„ìœ¨ -->
    <div class="stat-card">
        <h3>ğŸ“Š ê°ì • ë¶„ì„ ë¹„ìœ¨</h3>
        <ul>
            {% for row in emotion_stats %}
                <li>{{ row['dominant'] }}: {{ row['count'] }}íšŒ</li>
            {% endfor %}
        </ul>
    </div>

    <!-- 2048 ìµœê³  ì ìˆ˜ -->
    <div class="stat-card">
        <h3>ğŸ† 2048 ìµœê³  ì ìˆ˜</h3>
        <p class="big-score">{{ max_score }}</p>
    </div>

    <!-- ìµœê·¼ 2048 ì ìˆ˜ -->
    <div class="stat-card">
        <h3>â° ìµœê·¼ 2048 ì ìˆ˜</h3>
        <ul>
            {% for score, time in recent_scores %}
                <li>{{ score }}ì  ({{ time }})</li>
            {% endfor %}
        </ul>
    </div>

</div>


<!-- ================= í•˜ë‹¨ í™•ì¥ ì˜ì—­ ================= -->

<div class="stats-bottom-grid">

    <!-- ê°ì • ë‹¬ë ¥ -->
    <div class="calendar-box">
        <div class="calendar-header">
            <button id="prevMonth">â—€</button>
            <span id="currentMonth"></span>
            <button id="nextMonth">â–¶</button>
        </div>

        <div class="calendar-weekdays">
            <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
        </div>

        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <!-- ê°ì • ë³€í™” ê·¸ë˜í”„ -->
    <div class="chart-box">
        <h3>ğŸ“ˆ ìµœê·¼ ê°ì • ë³€í™”</h3>
        <canvas id="emotionChart"></canvas>
    </div>

</div>

<!-- ì˜¤ëŠ˜ì˜ í•œë§ˆë”” -->
<div class="quote-box">
    ğŸŒ± ì˜¤ëŠ˜ì˜ í•œë§ˆë””
    <p>{{ today_quote }}</p>
</div>

<!-- ê°ì • & ê²Œì„ ìƒê´€ê´€ê³„ -->
<div class="relation-box">
    <h3>ğŸ® ê°ì • & ê²Œì„ ìƒê´€ê´€ê³„</h3>
    <p>ğŸ˜Š ê¸ì •ì¼ ë•Œ í‰ê·  ì ìˆ˜: {{ relation.positive }} ì </p>
    <p>ğŸ˜ ë³´í†µì¼ ë•Œ í‰ê·  ì ìˆ˜: {{ relation.neutral }} ì </p>
    <p>ğŸ˜¢ ë¶€ì •ì¼ ë•Œ í‰ê·  ì ìˆ˜: {{ relation.negative }} ì </p>
</div>

{% endblock %}



{% block extra_js %}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const emotionMap = {{ emotion_map | tojson }};
let currentDate = new Date();

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    document.getElementById("currentMonth").innerText = `${year}ë…„ ${month + 1}ì›”`;

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    const grid = document.getElementById("calendarGrid");
    grid.innerHTML = "";

    for (let i = 0; i < firstDay; i++) {
        grid.innerHTML += `<div class="calendar-cell empty"></div>`;
    }

    for (let day = 1; day <= lastDate; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const emotion = emotionMap[dateStr];

        let dot = "";
        if (emotion === "positive") dot = `<span class="dot positive"></span>`;
        if (emotion === "neutral")  dot = `<span class="dot neutral"></span>`;
        if (emotion === "negative") dot = `<span class="dot negative"></span>`;

        grid.innerHTML += `
            <div class="calendar-cell">
                <span class="date-number">${day}</span>
                ${dot}
            </div>
        `;
    }
}

document.getElementById("prevMonth").onclick = () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
};

document.getElementById("nextMonth").onclick = () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
};

renderCalendar();
</script>

<script>
const ctx = document.getElementById('emotionChart');

new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ emotion_dates | tojson }},
        datasets: [{
            label: 'ê°ì • ë³€í™”',
            data: {{ emotion_scores | tojson }},
            tension: 0.4,
            fill: false
        }]
    },
    options: {
        scales: {
            y: {
                min: -1,
                max: 1,
                ticks: {
                    callback: function(value) {
                        if (value === 1) return 'ê¸ì •';
                        if (value === 0) return 'ë³´í†µ';
                        if (value === -1) return 'ë¶€ì •';
                    }
                }
            }
        }
    }
});
</script>

{% endblock %}

