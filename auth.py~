from flask import Blueprint, render_template, request, redirect, session, flash
import sqlite3
from werkzeug.security import generate_password_hash, check_password_hash

auth = Blueprint("auth", __name__)

DB_PATH = "users.db"

# ======================
# 로그인
# ======================
@auth.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        username = request.form.get("username")
        password = request.form.get("password")

        # ✅ 관리자 계정 (하드코딩)
        if username == "stumna" and password == "whdwhdwhd1%":
            session.clear()
            session["user_id"] = -1
            session["username"] = "stumna"
            session["is_admin"] = True
            flash("관리자로 로그인되었습니다.")
            return redirect("/")

        # ✅ 일반 사용자
        conn = sqlite3.connect(DB_PATH)
        cur = conn.cursor()
        cur.execute(
            "SELECT id, password FROM users WHERE username = ?",
            (username,)
        )
        user = cur.fetchone()
        conn.close()

        if user and check_password_hash(user[1], password):
            session.clear()
            session["user_id"] = user[0]
            session["username"] = username
            session["is_admin"] = False
            flash("로그인 성공")
            return redirect("/")

        flash("아이디 또는 비밀번호가 틀렸습니다.")

    return render_template("login.html")


# ======================
# 로그아웃 (❗ 하나만 존재해야 함)
# ======================
@auth.route("/logout")
def logout():
    session.clear()
    flash("정상적으로 로그아웃되었습니다.")
    return redirect("/login")


# ======================
# 회원가입
# ======================
@auth.route("/register", methods=["GET", "POST"])
def register():
    if request.method == "POST":
        username = request.form.get("username")
        password = request.form.get("password")

        if not username or not password:
            flash("아이디와 비밀번호를 입력하세요.")
            return redirect("/register")

        hashed_pw = generate_password_hash(password)

        try:
            conn = sqlite3.connect(DB_PATH)
            cur = conn.cursor()
            cur.execute(
                "INSERT INTO users (username, password) VALUES (?, ?)",
                (username, hashed_pw)
            )
            conn.commit()
            conn.close()

            flash("회원가입이 완료되었습니다. 로그인하세요.")
            return redirect("/login")

        except sqlite3.IntegrityError:
            # ✅ username UNIQUE 충돌
            flash("이미 존재하는 사용자입니다.")
            return redirect("/register")

    return render_template("register.html")

